<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>پنل</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">

    <div class="topbar">
      <div>
        <h1 class="title">پنل مدیریت سابسکریپشن‌ها</h1>
        <div class="subtle">ایجاد، ویرایش، غیرفعال‌سازی و مدیریت لینک‌ها</div>
      </div>

      <form method="post" action="/logout">
        <button class="btn btn-ghost" type="submit">خروج</button>
      </form>
    </div>

    <div class="grid">
      <div class="card">
        <h3>ایجاد لینک سابسکریپشن</h3>
        <div class="row">
          <a class="btn btn-primary" href="/admin/new">ایجاد جدید</a>
          <span class="subtle">نام + متن کانفیگ‌ها را paste کن</span>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">لیست لینک‌های سابسکریپشن</h3>
          <span class="subtle">{{ subs|length }} مورد</span>
        </div>

        <hr class="sep">

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="min-width:180px">نام</th>
                <th style="min-width:120px">وضعیت</th>
                <th>لینک‌ها</th>
                <th style="min-width:360px">عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for s in subs %}
              <tr>
                <td>
                  <b>{{ s["name"] }}</b>
                  <div class="subtle" style="margin-top:6px">ID: {{ s["id"] }}</div>
                </td>

                <td>
                  {% if s["is_active"] == 1 %}
                    <span class="badge badge-ok">فعال</span>
                  {% else %}
                    <span class="badge badge-off">غیرفعال</span>
                  {% endif %}
                </td>

                <td>
                  {% set url_b64 = base_url ~ '/s/' ~ s['token'] %}
                  {% set url_raw = base_url ~ '/s/' ~ s['token'] ~ '?b64=0' %}

                  <div class="urlbox">
                    <span class="urltag">b64</span>

                    <span class="urltext" id="urlb64-{{ s['id'] }}">{{ url_b64 }}</span>

                    <!-- QR -->
                    <button class="copyicon" type="button" title="QR Code" onclick="openQr('{{ url_b64 }}')">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M3 3h8v8H3V3Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M13 3h8v8h-8V3Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M3 13h8v8H3v-8Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M15 13h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M19 13h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M15 17h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M17 15h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M19 17h2v4h-6v-2h4v-2Z" fill="currentColor"/>
                      </svg>
                    </button>

                    <!-- Copy -->
                    <button class="copyicon" type="button" title="کپی لینک" onclick="copyById('urlb64-{{ s['id'] }}')">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M9 9h10v10H9V9Z" stroke="currentColor" stroke-width="2" />
                        <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    </button>
                  </div>

                  <div style="height:10px"></div>

                  <div class="urlbox">
                    <span class="urltag">raw</span>

                    <span class="urltext" id="urlraw-{{ s['id'] }}">{{ url_raw }}</span>

                    <!-- QR -->
                    <button class="copyicon" type="button" title="QR Code" onclick="openQr('{{ url_raw }}')">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M3 3h8v8H3V3Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M13 3h8v8h-8V3Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M3 13h8v8H3v-8Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M15 13h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M19 13h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M15 17h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M17 15h2v2h-2v-2Z" fill="currentColor"/>
                        <path d="M19 17h2v4h-6v-2h4v-2Z" fill="currentColor"/>
                      </svg>
                    </button>

                    <!-- Copy -->
                    <button class="copyicon" type="button" title="کپی لینک" onclick="copyById('urlraw-{{ s['id'] }}')">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M9 9h10v10H9V9Z" stroke="currentColor" stroke-width="2" />
                        <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    </button>
                  </div>
                </td>

                <td>
                  <div class="actions">
                    <a class="btn" href="/admin/edit/{{ s['id'] }}">ويرايش</a>

                    <form method="post" action="/admin/toggle">
                      <input type="hidden" name="sub_id" value="{{ s['id'] }}">
                      <button class="btn" type="submit">
                        {% if s["is_active"] == 1 %}غیرفعال‌سازی{% else %}فعالسازي{% endif %}
                      </button>
                    </form>

                    <form method="post" action="/admin/rotate" onsubmit="return confirm('لینک تغییر کند؟ لینک قبلی از کار می‌افتد.');">
                      <input type="hidden" name="sub_id" value="{{ s['id'] }}">
                      <button class="btn" type="submit">تعویض URL</button>
                    </form>

                    <form method="post" action="/admin/delete" onsubmit="return confirm('حذف شود؟');">
                      <input type="hidden" name="sub_id" value="{{ s['id'] }}">
                      <button class="btn btn-danger" type="submit">حذف</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}

              {% if subs|length == 0 %}
              <tr><td colspan="4" class="subtle">هنوز چیزی ساخته نشده.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div id="toast" class="toast">کپی شد ✅</div>

  <!-- QR Modal -->
  <div id="qrModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
      <div class="modal-head">
        <button class="iconbtn" type="button" aria-label="Close" onclick="closeQr()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div id="qrTitle" class="modal-title">QR Code</div>
      </div>

      <div class="modal-body">
        <div class="qr-wrap">
          <img id="qrImg" class="qr-img" alt="QR" src="" />
        </div>

        <div id="qrUrl" class="qr-url"></div>

        <div class="row" style="justify-content:flex-end; margin-top:12px">
          <button class="btn" type="button" onclick="closeQr()">بستن</button>
        </div>
      </div>
    </div>
  </div>

<script>
  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg || 'کپی شد ✅';
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1200);
  }

  async function copyById(elementId){
    const el = document.getElementById(elementId);
    const text = (el?.innerText || '').trim();
    if (!text) return;

    try {
      await navigator.clipboard.writeText(text);
      showToast('کپی شد ✅');
    } catch (e) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('کپی شد ✅');
    }
  }

  function openQr(url){
    const modal = document.getElementById('qrModal');
    const img = document.getElementById('qrImg');
    const urlBox = document.getElementById('qrUrl');

    // cache-bust برای اینکه همیشه رفرش بشه
    const src = '/qr?url=' + encodeURIComponent(url) + '&_=' + Date.now();

    img.src = src;
    urlBox.textContent = url;

    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeQr(){
    const modal = document.getElementById('qrModal');
    const img = document.getElementById('qrImg');

    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    img.src = '';
  }

  // بستن با کلیک روی بک‌دراپ
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('qrModal');
    if (!modal.classList.contains('show')) return;
    if (e.target === modal) closeQr();
  });

  // بستن با ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeQr();
  });
</script>

</body>
</html>
